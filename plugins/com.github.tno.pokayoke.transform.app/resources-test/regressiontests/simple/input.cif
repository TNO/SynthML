
enum Position = AtLocation2,  AtLocation1;
enum UnknownBool = True, False, Unknown;


/** Specification */

plant Spec:
    controllable Prepare_robot;
    controllable Robot_move_to_location1;
    controllable Robot_move_to_location2;
    controllable Robot_adjust_product;
    controllable Robot_release_product;

    controllable Prepare_location1;
    controllable Measure_product_position;
    uncontrollable Position_1;
    uncontrollable Position_2;


    disc bool Robot_prepared = false;
    disc bool Robot_has_product = true;
    disc Position Robot_position = AtLocation2;


    disc bool Location1_prepared = false;
    disc bool Location1_has_product = false;
    disc UnknownBool Location1_is_correctly_placed = Unknown;

    location Home:
        initial;
        marked;
        edge Prepare_robot when not Robot_prepared do Robot_prepared := true;
        edge Robot_move_to_location1 when Robot_prepared do Robot_position := AtLocation1;
        edge Robot_move_to_location2 when not Robot_has_product do Robot_position := AtLocation2;
        edge Robot_adjust_product when Robot_prepared and Location1_is_correctly_placed = False do Location1_is_correctly_placed := Unknown;
        edge Robot_release_product when Robot_prepared and Robot_position = AtLocation1 do Robot_has_product := false, Location1_has_product := true;
        edge Prepare_location1 when not Location1_prepared do Location1_prepared := true;
        edge Measure_product_position when Location1_prepared and Location1_has_product and Location1_is_correctly_placed = Unknown;
        edge Position_1 do Location1_is_correctly_placed := True;
        edge Position_2 do Location1_is_correctly_placed := False;
end


/** Auxiliary */

requirement def HappensAtMostOnce(controllable c_event):
    location NotYetOccurred:
        initial;
        marked;
        edge c_event goto Occurred;
    location Occurred:
        marked;
end

requirement def HappensAtMostTwice(controllable c_event):
    location NotYetOccurred:
        initial;
        marked;
        edge c_event goto OccurredOnce;
    location OccurredOnce:
        marked;
        edge c_event goto OccurredTwice;
    location OccurredTwice:
        marked;
end

requirement def PostCondition(alg bool condition):
    controllable c_satisfied;

    location NotSatisfied:
        initial;
        edge c_satisfied when condition goto Satisfied;
    location Satisfied:
        marked;
end

plant automaton constraint:
  location idle:
    initial; marked;
    edge Spec.Measure_product_position goto busy;
    edge Spec.Prepare_robot;
    edge Spec.Robot_move_to_location1;
    edge Spec.Robot_adjust_product;
    edge Spec.Robot_release_product;
    edge Spec.Prepare_location1;
  location busy:
    edge Spec.Position_1 goto idle;
    edge Spec.Position_2 goto idle;
end



/** Requirements */

// Number of occurrences of actions.
Prepare_robot_happens_once : HappensAtMostOnce(Spec.Prepare_robot);
Robot_move_to_location1_happens_once : HappensAtMostOnce(Spec.Robot_move_to_location1);
Robot_release_product_happens_once : HappensAtMostOnce(Spec.Robot_release_product);
Prepare_location1_happens_once : HappensAtMostOnce(Spec.Prepare_location1);

// Ordering constraints.
requirement Spec.Robot_move_to_location1 needs Spec.Robot_position = AtLocation2 and  Spec.Location1_prepared;
requirement Spec.Robot_move_to_location2 needs Spec.Robot_position = AtLocation1 and  Spec.Location1_prepared;
requirement Spec.Robot_adjust_product needs Spec.Robot_position = AtLocation1;


// Postconditions.
Post : PostCondition(
    not Spec.Robot_has_product and
    Spec.Robot_position = AtLocation2 and

    Spec.Location1_has_product and
    Spec.Location1_is_correctly_placed = True
);
