// Enums.
enum RobotLocation = Location1, Location2;
enum UnknownBool = True, False, Unknown;

plant Context:
	// Actions.
    controllable prepare_robot;
    controllable robot_move_to_location1;
    controllable robot_move_to_location2;
    controllable robot_adjust_product;
    controllable robot_release_product_at_location2;
    controllable prepare_location2;
    controllable measure_product_position;
    uncontrollable measure_product_position_result_1;
    uncontrollable measure_product_position_result_2;

	// Data properties.
    disc bool robotPrepared = false;
    disc bool location2Prepared = false;
    disc RobotLocation robotLocation = Location1;
    disc bool robotHasProduct = true;
    disc bool location2HasProduct = false;
    disc UnknownBool productCorrectlyPlaced = Unknown;

	// Action guards and updates.
    location:
        initial;
        marked;
        edge measure_product_position when location2Prepared and location2HasProduct and productCorrectlyPlaced = Unknown;
        edge measure_product_position_result_1 do productCorrectlyPlaced := True;
        edge measure_product_position_result_2 do productCorrectlyPlaced := False;
        edge prepare_location2 when not location2Prepared do location2Prepared := true;
		edge prepare_robot when not robotPrepared do robotPrepared := true;
		edge robot_adjust_product when robotPrepared and productCorrectlyPlaced = False do productCorrectlyPlaced := Unknown;
		edge robot_move_to_location1 when robotPrepared do robotLocation := Location1;
		edge robot_move_to_location2 when robotPrepared do robotLocation := Location2;
        edge robot_release_product_at_location2 when robotPrepared and robotLocation = Location2 do robotHasProduct := false, location2HasProduct := true;
end

requirement def HappensAtMostOnce(controllable c_event):
    location NotYetOccurred:
        initial;
        marked;
        edge c_event goto Occurred;
    location Occurred:
        marked;
end

requirement def PostCondition(alg bool condition):
    controllable c_satisfied;
    location NotSatisfied:
        initial;
        edge c_satisfied when condition goto Satisfied;
    location Satisfied:
        marked;
end

plant automaton constraint:
  location idle:
    initial; marked;
    edge Context.measure_product_position goto busy;
    edge Context.prepare_robot;
    edge Context.robot_move_to_location2;
    edge Context.robot_adjust_product;
    edge Context.robot_release_product_at_location2;
    edge Context.prepare_location2;
    edge Context.robot_move_to_location1;
  location busy:
    edge Context.measure_product_position_result_1 goto idle;
    edge Context.measure_product_position_result_2 goto idle;
end

// Requirements.
Prepare_robot_happens_once : HappensAtMostOnce(Context.prepare_robot);
Robot_move_to_Location2_happens_once : HappensAtMostOnce(Context.robot_move_to_location2);
Robot_release_product_at_location2_happens_once : HappensAtMostOnce(Context.robot_release_product_at_location2);
Prepare_Location2_happens_once : HappensAtMostOnce(Context.prepare_location2);

requirement Req1 : Context.robot_move_to_location2 needs Context.robotLocation = Location1 and Context.location2Prepared;
requirement Req2 : Context.robot_move_to_location1 needs Context.robotLocation = Location2;
requirement Req3 : Context.robot_adjust_product needs Context.robotLocation = Location2;

// Activity postcondition.
Post : PostCondition(
    not Context.robotHasProduct and
    Context.robotLocation = Location1 and
    Context.location2HasProduct and
    Context.productCorrectlyPlaced = True
);
